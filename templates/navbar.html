<header class="mb-3">
  <nav class="navbar navbar-expand-lg navbar-dark bg-transparent">
    <div class="container-fluid px-0">

      <!-- Brand -->
      <a class="navbar-brand d-flex align-items-center gap-2" href="{{ url_for('index') }}">
        <div class="logo-pill">
          <span class="logo-dot"></span>
          <span class="logo-text">EME</span>
        </div>
        <span class="fw-bold">MD-01</span>
      </a>

      <!-- Toggler -->
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav"
              aria-controls="mainNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse justify-content-between" id="mainNav">
        <!-- Left: navigation -->
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          {% set current = request.endpoint %}

          <li class="nav-item">
            <a class="nav-link {% if current in ('index',) %}active{% endif %}" href="{{ url_for('index') }}">
              Data view
            </a>
          </li>

          <li class="nav-item">
            <a class="nav-link {% if current in ('control',) %}active{% endif %}" href="{{ url_for('control') }}">
              Control
            </a>
          </li>

          <li class="nav-item">
            <a class="nav-link {% if current in ('data_page',) %}active{% endif %}" href="{{ url_for('data_page') }}">
              EME data
            </a>
          </li>
        </ul>

        <!-- Right: connections + auth -->
        <div class="d-flex align-items-center gap-3 flex-wrap justify-content-end">

          <!-- Connections status pill -->
          <span class="connection-pill">
            <span class="connection-dot {% if not state.connected %}offline{% endif %}" id="conn-dot"></span>
            <span class="small" id="conn-label">
              {{ "Connected" if state.connected else "Not connected" }}
            </span>
          </span>

          <!-- MD-01 connect -->
          <form id="viewConnectForm" class="d-flex align-items-center gap-2 m-0">
            {% set preferred = "COM5" %}
            <select name="port" class="form-select form-select-sm" style="min-width: 120px;">
              {% if preferred in ports %}
                <option value="{{ preferred }}" {% if state.port == preferred or not state.port %}selected{% endif %}>{{ preferred }}</option>
              {% endif %}
              {% for p in ports %}
                {% if p != preferred %}
                  <option value="{{ p }}" {% if state.port == p %}selected{% endif %}>{{ p }}</option>
                {% endif %}
              {% endfor %}
            </select>

            <button id="viewMdToggleBtn" type="submit" class="btn btn-outline-success btn-sm">
              Connect MD-01
            </button>
          </form>

          <!-- Pico connect -->
          <form id="coaxConnectForm" class="d-flex align-items-center gap-2 m-0">
            {% set preferred_sw = "COM7" %}
            <select name="port" class="form-select form-select-sm" style="min-width: 120px;">
              {% if preferred_sw in ports %}
                <option value="{{ preferred_sw }}" {% if state.switch_port == preferred_sw or not state.switch_port %}selected{% endif %}>{{ preferred_sw }}</option>
              {% endif %}
              {% for p in ports %}
                {% if p != preferred_sw %}
                  <option value="{{ p }}" {% if state.switch_port == p %}selected{% endif %}>{{ p }}</option>
                {% endif %}
              {% endfor %}
            </select>

            <button id="viewPicoToggleBtn" type="submit" class="btn btn-outline-info btn-sm">
              Connect Pico
            </button>
          </form>

          <!-- Auth -->
          <div class="d-flex align-items-center gap-2">
            {% if can_edit %}
              <span class="text-success small me-1">Control unlocked</span>
              <form action="{{ url_for('logout') }}" method="post" class="m-0">
                <button type="submit" class="btn btn-outline-light btn-sm">
                  Logout
                </button>
              </form>
            {% else %}
              <a href="{{ url_for('control') }}" class="btn btn-outline-success btn-sm">
                Control login
              </a>
            {% endif %}
          </div>
          </small>
        </div>
      </div>
    </div>
  </nav>
</header>
