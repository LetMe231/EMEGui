<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MD-01 - Data View</title>

  <!-- Bootstrap -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >

  <!-- Custom styles -->
  <link href="/static/style.css" rel="stylesheet">

  <!-- RF schematic-specific styles -->
  <style>
    /* Schematic card uses same glass background; only fine-tune inside SVG */
    #rf-schematic {
      width: 100%;
      max-width: 100%;
      height: 220px;
      background: rgba(15, 23, 42, 0.95);
      border-radius: 0.75rem;
      border: 1px solid rgba(148, 163, 184, 0.35);
    }

    #rf-schematic text {
      fill: #e5e7eb;
      font-size: 11px;
    }

    #rf-schematic .title {
      font-size: 14px;
      font-weight: 600;
      text-anchor: middle;
      fill: #f9fafb;
    }

    #rf-schematic .hint {
      font-size: 10px;
      fill: #9ca3af;
      text-anchor: middle;
    }

    #rf-schematic .wire {
      stroke: #4b5563;
      stroke-width: 2;
      fill: none;
      transition: stroke 120ms ease, stroke-width 120ms ease;
    }

    #rf-schematic .wire.active {
      stroke: #22c55e; /* bright green */
      stroke-width: 3;
      filter: drop-shadow(0 0 6px rgba(34, 197, 94, 0.6));
    }

    #rf-schematic .wire.error {
      stroke: #f97373; /* red-ish */
      stroke-width: 3;
      filter: drop-shadow(0 0 6px rgba(248, 113, 113, 0.7));
    }

    #rf-schematic .switch-terminal {
      fill: #020617;
      stroke: #9ca3af;
      stroke-width: 1.2;
    }

    #rf-schematic .switch-com {
      fill: #020617;
      stroke: #f9fafb;
      stroke-width: 1.4;
    }

    #rf-schematic .switch-handle {
      stroke: #e5e7eb;
      stroke-width: 2;
      stroke-linecap: round;
    }

    #rf-schematic .switch-label {
      font-size: 11px;
      text-anchor: middle;
      fill: #e5e7eb;
    }

    #rf-schematic .amp-body {
      fill: #020617;
      stroke: #cbd5f5;
      stroke-width: 1.5;
    }

    #rf-schematic .amp-label {
      font-size: 10px;
      text-anchor: middle;
      fill: #e5e7eb;
    }

    /* Antenna waves */
    #rf-schematic .ant-wave {
      fill: none;
      stroke-width: 1.8;
      opacity: 0;
      transform-box: fill-box;
      transform-origin: 0px -38px;
    }

    #rf-schematic .ant-wave-tx {
      stroke: #22c55e; /* TX green */
    }

    #rf-schematic .ant-wave-rx {
      stroke: #38bdf8; /* RX cyan */
      stroke-dasharray: 4 3;
    }

    #rf-schematic .ant-wave-tx.active {
      opacity: 1;
      animation: rf-radiate-tx 0.9s infinite ease-out;
    }

    #rf-schematic .ant-wave-rx.active {
      opacity: 0.7;
      animation: rf-radiate-rx 1.1s infinite ease-in-out;
    }

    @keyframes rf-radiate-tx {
      0% {
        transform: translate(0px, 0px) scale(0.85);
        opacity: 0.95;
      }
      100% {
        transform: translate(10px, -45px) scale(1.4);
        opacity: 0;
      }
    }

    @keyframes rf-radiate-rx {
      0% {
        transform: translate(8px, -30px) scale(1.2);
        opacity: 0.7;
      }
      100% {
        transform: translate(0px, -8px) scale(0.95);
        opacity: 0.25;
      }
    }
  </style>
</head>

<body class="app-body text-center dark-mode">
  <div class="app-shell container-fluid py-3">

    <!-- Top bar with logo, nav, and both connect blocks -->
    <header class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-3">

      <!-- Left: logo + antenna icon -->
      <div class="d-flex align-items-center gap-3 text-start">
        <div class="logo-pill d-flex align-items-center gap-2">
          <span class="logo-dot"></span>
          <span class="logo-text">EME</span>
          <!-- small antenna icon -->
          <svg width="28" height="24" viewBox="0 0 28 24" aria-hidden="true">
            <g stroke="#38bdf8" stroke-width="1.5" fill="none" stroke-linecap="round">
              <line x1="14" y1="22" x2="14" y2="10" />
              <line x1="14" y1="10" x2="8" y2="4" />
              <line x1="14" y1="10" x2="20" y2="4" />
              <path d="M5 3 Q 14 -2 23 3" stroke-opacity="0.7" />
              <path d="M2 5 Q 14 -4 26 5" stroke-opacity="0.4" />
            </g>
          </svg>
        </div>
        <div class="text-start">
          <h1 class="h5 mb-0 fw-bold">MD-01 Dashboard</h1>
          <small class="text-muted d-block">Live data · read-only</small>
        </div>
      </div>

      <!-- Middle: navigation between pages -->
      <nav class="d-flex align-items-center gap-2 flex-wrap">
        <a href="{{ url_for('index') }}" class="btn btn-sm btn-outline-light active">
          Data
        </a>
        <a href="{{ url_for('control') }}" class="btn btn-sm btn-outline-light">
          Control
        </a>
      </nav>

      <!-- Right: MD-01 connect + Pico coax connect -->
      <div class="d-flex align-items-center gap-4 flex-wrap justify-content-end">

        <!-- MD-01 connect (public) -->
        <div class="d-flex align-items-center gap-2">
          <span class="connection-pill me-1">
            <span class="connection-dot" id="conn-dot"></span>
            <span class="small" id="conn-label">
              {{ "Connected" if state.connected else "Not connected" }}
            </span>
          </span>

          <form id="viewConnectForm" class="d-flex align-items-center gap-2">
            {% set preferred = "COM7" %}
            <select name="port" class="form-select form-select-sm">
              {# Prefer COM7 if present #}
              {% if preferred in ports %}
                <option value="{{ preferred }}"
                  {% if state.port == preferred or not state.port %}selected{% endif %}>
                  {{ preferred }}
                </option>
              {% endif %}
              {% for p in ports %}
                {% if p != preferred %}
                  <option value="{{ p }}"
                    {% if state.port == p %}selected{% endif %}>
                    {{ p }}
                  </option>
                {% endif %}
              {% endfor %}
            </select>

            <span class="small text-muted">
              Port:
              <span id="view-port-text">{{ state.port or (preferred if preferred in ports else "—") }}</span>
            </span>

            <button type="submit" class="btn btn-outline-success btn-sm">
              Connect
            </button>
          </form>
        </div>

        <!-- Pico coax connect (will still require login; backend enforces it) -->
        <div class="d-flex align-items-center gap-2">
          <span class="small text-muted">Pico:</span>
          <form id="coaxConnectForm" class="d-flex align-items-center gap-2">
            {% set preferred_sw = "COM7" %}
            <select name="port" class="form-select form-select-sm">
              {% if preferred_sw in ports %}
                <option value="{{ preferred_sw }}"
                  {% if state.switch_port == preferred_sw or not state.switch_port %}selected{% endif %}>
                  {{ preferred_sw }}
                </option>
              {% endif %}
              {% for p in ports %}
                {% if p != preferred_sw %}
                  <option value="{{ p }}"
                    {% if state.switch_port == p %}selected{% endif %}>
                    {{ p }}
                  </option>
                {% endif %}
              {% endfor %}
            </select>

            <span class="small text-muted">
              Port:
              <span id="coax-port-text">{{ state.switch_port or (preferred_sw if preferred_sw in ports else "—") }}</span>
            </span>

            <button id="coaxConnectBtn" type="submit" class="btn btn-outline-info btn-sm">
              Connect
            </button>
            <button id="coaxDisconnectBtn" type="button" class="btn btn-outline-danger btn-sm">
              Disconnect
            </button>
          </form>
        </div>

      </div>
    </header>

    <!-- Main content -->
    <section class="mt-2">
      <!-- Top row: dials + camera (no more connection card here) -->
      <div class="row g-3 mb-3">

        <!-- Azimuth dial -->
        <div class="col-xl-4 col-lg-6">
          <div class="glass-card h-100">
            <div class="card-header border-0 py-2 px-3 d-flex justify-content-between align-items-center">
              <span class="fw-semibold">Azimuth Dial</span>
              <span class="badge bg-dark-subtle text-light-emphasis small">0–360°</span>
            </div>
            <div class="card-body">
              <canvas id="azCanvas" width="280" height="260" class="rounded"></canvas>
              <div class="mt-3 dial-texts">
                <p id="azText" class="status-text mb-1">Antenna absolute azimuth: --°</p>
                <p id="azNormText" class="status-text mb-1">Antenna normed azimuth: --°</p>
                <p id="azMoonText" class="moon-text mb-0">Moon angle: --°</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Elevation dial -->
        <div class="col-xl-4 col-lg-6">
          <div class="glass-card h-100">
            <div class="card-header border-0 py-2 px-3 d-flex justify-content-between align-items-center">
              <span class="fw-semibold">Elevation Dial</span>
              <span class="badge bg-dark-subtle text-light-emphasis small">0–90°</span>
            </div>
            <div class="card-body">
              <canvas id="elCanvas" width="280" height="260" class="rounded"></canvas>
              <div class="mt-3 dial-texts">
                <p id="elText" class="status-text mb-1">Antenna elevation: --°</p>
                <p id="elMoonText" class="moon-text mb-0">Moon angle: --°</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Camera -->
        <div class="col-xl-4 col-lg-12">
          <div class="glass-card h-100">
            <div class="card-header border-0 py-2 px-3 d-flex justify-content-between align-items-center">
              <span class="fw-semibold">Antenna Camera</span>
              <div class="btn-group btn-group-sm">
                <button id="camFsBtn" type="button" class="btn btn-outline-info">
                  ⛶ Fullscreen
                </button>
              </div>
            </div>

            <div class="card-body">
              <div id="camFsContainer" class="cam-fs-container rounded overflow-hidden position-relative">
                <img
                  id="camStream"
                  src="/video.mjpg?ts=0"
                  data-src="/video.mjpg"
                  alt="Camera stream"
                  class="camera-frame w-100"
                >
                <div id="camOverlay" class="cam-overlay" hidden>
                  No video signal
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>

      <!-- Second row: coax positions + RF schematic -->
      <div class="row g-3">
        <!-- Coax status + pills (read-only) -->
        <div class="col-xl-3 col-lg-6">
          <div class="glass-card h-100">
            <div class="card-header border-0 py-2 px-3 d-flex justify-content-between align-items-center">
              <span class="fw-semibold">Coax Switches</span>
              <span class="coax-conn d-inline-flex align-items-center gap-1">
                <span class="coax-dot" id="coax-conn-dot"></span>
                <small id="coax-conn-text">Offline</small>
              </span>
            </div>

            <div class="card-body text-start">
              <!-- Status line (online/offline + summary) -->
              <div id="coax-status" class="small mb-2"></div>

              <!-- Read-only pills for S1/S2/S3 -->
              <div id="coax-view-grid" class="coax-grid coax-grid-readonly">
                <div class="coax-row">
                  <span class="coax-label">S1</span>
                  <div class="coax-pill-group">
                    <span id="coax-view-1-1" class="coax-pill">1</span>
                    <span id="coax-view-1-2" class="coax-pill">2</span>
                  </div>
                </div>

                <div class="coax-row">
                  <span class="coax-label">S2</span>
                  <div class="coax-pill-group">
                    <span id="coax-view-2-1" class="coax-pill">1</span>
                    <span id="coax-view-2-2" class="coax-pill">2</span>
                  </div>
                </div>

                <div class="coax-row">
                  <span class="coax-label">S3</span>
                  <div class="coax-pill-group">
                    <span id="coax-view-3-1" class="coax-pill">1</span>
                    <span id="coax-view-3-2" class="coax-pill">2</span>
                  </div>
                </div>
              </div>

              <small class="text-muted d-block mt-2">
                Read-only: positions follow the Pico coax switch state.
              </small>
            </div>
          </div>
        </div>

        <!-- RF schematic card -->
        <div class="col-xl-9 col-lg-6">
          <div class="glass-card h-100">
            <div class="card-header border-0 py-2 px-3 d-flex justify-content-between align-items-center">
              <span class="fw-semibold">RF Path Schematic</span>
              <span class="badge bg-secondary-subtle text-secondary-emphasis small">
                TX &amp; RX paths · live
              </span>
            </div>
            <div class="card-body">
              <div class="coax-schematic-wrap">
                <svg id="rf-schematic" viewBox="0 0 820 220">

                  <!-- TX and RX sources -->
                  <circle cx="70" cy="90" r="8" stroke="#aaa" stroke-width="1.5" fill="#222" />
                  <text x="70" y="75" text-anchor="middle">TX</text>

                  <circle cx="70" cy="130" r="8" stroke="#aaa" stroke-width="1.5" fill="#222" />
                  <text x="70" y="145" text-anchor="middle">RX</text>

                  <!-- TX → PA input -->
                  <path id="w_tx_to_pa" class="wire" d="M78 90 H 100" />

                  <!-- PA block (y = 90) -->
                  <g transform="translate(120,90)">
                    <rect class="amp-body" x="-20" y="-10" width="40" height="20" />
                    <text class="amp-label" x="0" y="4">PA</text>
                  </g>

                  <!-- PA → S1 P1 -->
                  <path id="w_pa_to_s1p1" class="wire" d="M140 90 H 170" />

                  <!-- RX → S1 P2 -->
                  <path id="w_rx_to_s1p2" class="wire" d="M78 130 H 170" />

                  <!-- Switch 1 (center = 120) -->
                  <g id="switch1" class="switch" data-state="p1" transform="translate(220,110)">
                    <circle class="switch-terminal" cx="-50" cy="-20" r="3" />
                    <circle class="switch-terminal" cx="-50" cy="20"  r="3" />
                    <circle class="switch-com"     cx="0"   cy="0"   r="3.5" />

                    <line id="s1_blade" class="switch-handle" x1="0" y1="0" x2="-50" y2="-20" />

                    <text class="switch-label" x="0" y="-40">S1</text>
                  </g>

                  <!-- S1 COM → S2 COM -->
                  <path id="w_s1com_to_s2com" class="wire" d="M224 110 H 415" />

                  <!-- Switch 2 (center = 110) -->
                  <g id="switch2" class="switch" data-state="p1" transform="translate(415,110)">
                    <circle class="switch-terminal" cx="50" cy="-20" r="3" />
                    <circle class="switch-terminal" cx="50" cy="20"  r="3" />
                    <circle class="switch-com"     cx="0"  cy="0"   r="3.5" />

                    <line id="s2_blade" class="switch-handle" x1="0" y1="0" x2="50" y2="-20" />

                    <text class="switch-label" x="0" y="-40">S2</text>
                  </g>

                  <!-- S2 P1 → LNA -->
                  <path id="w_s2p1_to_lna" class="wire" d="M465 90 H 525" />

                  <!-- LNA block -->
                  <g transform="translate(545,90)">
                    <rect class="amp-body" x="-20" y="-10" width="40" height="20" />
                    <text class="amp-label" x="0" y="4">LNA</text>
                  </g>

                  <!-- LNA → S3 P1 -->
                  <path id="w_lna_to_s3p1" class="wire" d="M565 90 H 625" />

                  <!-- S2 P2 → S3 P2 -->
                  <path id="w_s2p2_to_s3p2" class="wire" d="M465 130 H 625" />

                  <!-- Switch 3 -->
                  <g id="switch3" class="switch" data-state="p1" transform="translate(675,110)">
                    <circle class="switch-terminal" cx="-50" cy="-20" r="3" />
                    <circle class="switch-terminal" cx="-50" cy="20"  r="3" />
                    <circle class="switch-com"     cx="0"   cy="0"   r="3.5" />

                    <line id="s3_blade" class="switch-handle" x1="0" y1="0" x2="-50" y2="-20" />

                    <text class="switch-label" x="0" y="-40">S3</text>
                  </g>

                  <!-- S3 → Antenna -->
                  <path id="w_s3com_to_out" class="wire" d="M679 110 H 750" />

                  <!-- Antenna -->
                  <g id="antenna" transform="translate(750,110)">
                    <line x1="0" y1="0" x2="0" y2="-15" stroke="#ccc" stroke-width="2" />
                    <line x1="0" y1="-15" x2="-10" y2="-23" stroke="#ccc" stroke-width="2" />
                    <line x1="0" y1="-15" x2="10"  y2="-23" stroke="#ccc" stroke-width="2" />
                    <text x="0" y="-26" text-anchor="middle">ANT</text>

                    <!-- TX waves -->
                    <g id="ant_tx_group">
                      <path class="ant-wave ant-wave-tx" d="M6 -23 Q 20 -33 34 -28" />
                      <path class="ant-wave ant-wave-tx" d="M9 -28 Q 26 -40 43 -34" />
                      <path class="ant-wave ant-wave-tx" d="M12 -33 Q 32 -47 52 -40" />
                    </g>

                    <!-- RX waves -->
                    <g id="ant_rx_group">
                      <path class="ant-wave ant-wave-rx" d="M12 -33 Q 32 -47 52 -40" />
                      <path class="ant-wave ant-wave-rx" d="M9 -28 Q 26 -40 43 -34" />
                      <path class="ant-wave ant-wave-rx" d="M6 -23 Q 20 -33 34 -28" />
                    </g>
                  </g>

                </svg>
              </div>

              <small class="text-muted d-block mt-2">
                Read-only: path and RF animation follow the Pico coax state.
              </small>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Status bar (sticky bottom) -->
  <div id="status-bar" class="statusbar">
    {{ state.status }}
  </div>

  <!-- JS bundle -->
  <script src="/static/app.js"></script>
</body>
</html>
