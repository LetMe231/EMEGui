<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MD-01 - Data View</title>

  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Custom styles -->
  <link href="/static/style.css" rel="stylesheet">
</head>

<body class="app-body text-center dark-mode view-page">
  <div class="app-shell container-fluid py-3">
    {% include "navbar.html" %}

    <!-- Connections (unified block for this page) -->
    <section class="mb-3">
      <div class="row g-3">
        <div class="col-12">
          <div class="glass-card card-connection">
            <div class="card-header border-0 py-2 px-3 d-flex justify-content-between align-items-center flex-wrap gap-2">
              <span class="fw-semibold">Connections</span>

              <span class="connection-pill">
                <span class="connection-dot {% if not state.connected %}offline{% endif %}" id="conn-dot"></span>
                <span class="small" id="conn-label">
                  {{ "Connected" if state.connected else "Not connected" }}
                </span>
              </span>
            </div>

            <div class="card-body">
              <div class="row g-3 align-items-center">
                <!-- MD-01 connect -->
                <div class="col-lg-6">
                  <div class="d-flex align-items-center gap-4 justify-content-end header-right-wrap">
                    <form id="viewConnectForm" class="d-flex align-items-center gap-2 header-connect-form">
                      {% set preferred = "COM5" %}
                      <select name="port" class="form-select form-select-sm" style="min-width: 120px;">
                        {% if preferred in ports %}
                          <option value="{{ preferred }}" {% if state.port == preferred or not state.port %}selected{% endif %}>{{ preferred }}</option>
                        {% endif %}
                        {% for p in ports %}
                          {% if p != preferred %}
                            <option value="{{ p }}" {% if state.port == p %}selected{% endif %}>{{ p }}</option>
                          {% endif %}
                        {% endfor %}
                      </select>

                      <span class="small text-muted">
                        Port: <span id="view-port-text">{{ state.port or (preferred if preferred in ports else "—") }}</span>
                      </span>

                      <button id="viewMdToggleBtn" type="submit" class="btn btn-outline-success btn-sm">
                        Connect MD-01
                      </button>
                    </form>

                    <!-- Pico connect -->
                    <form id="coaxConnectForm" class="d-flex align-items-center gap-2 header-connect-form">
                      {% set preferred_sw = "COM7" %}
                      <select name="port" class="form-select form-select-sm" style="min-width: 120px;">
                        {% if preferred_sw in ports %}
                          <option value="{{ preferred_sw }}" {% if state.switch_port == preferred_sw or not state.switch_port %}selected{% endif %}>{{ preferred_sw }}</option>
                        {% endif %}
                        {% for p in ports %}
                          {% if p != preferred_sw %}
                            <option value="{{ p }}" {% if state.switch_port == p %}selected{% endif %}>{{ p }}</option>
                          {% endif %}
                        {% endfor %}
                      </select>

                      <span class="small text-muted">
                        Port: <span id="coax-port-text">{{ state.switch_port or (preferred_sw if preferred_sw in ports else "—") }}</span>
                      </span>

                      <button id="viewPicoToggleBtn" type="submit" class="btn btn-outline-info btn-sm">
                        Connect Pico
                      </button>
                    </form>
                  </div>

                  <small class="text-muted d-block mt-2">
                    Read-only view: coax positions and RF path mirror the Pico state (control requires login).
                  </small>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </section>

    <!-- Main content -->
    <section>
      <!-- Row 1: dials + camera -->
      <div class="row g-3 mb-3">

        <!-- Azimuth dial -->
        <div class="col-xl-4 col-lg-6">
          <div class="glass-card h-100">
            <div class="card-header border-0 py-2 px-3 d-flex justify-content-between align-items-center">
              <span class="fw-semibold">Azimuth Dial</span>
              <span class="badge bg-dark-subtle text-light-emphasis small">0–360°</span>
            </div>
            <div class="card-body">
              <canvas id="azCanvas" width="280" height="260" class="rounded"></canvas>
              <div class="mt-3 dial-texts">
                <p id="azText" class="status-text mb-1">Antenna absolute azimuth: --°</p>
                <p id="azNormText" class="status-text mb-1">Antenna normed azimuth: --°</p>
                <p id="azMoonText" class="moon-text mb-0">Moon angle: --°</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Elevation dial -->
        <div class="col-xl-4 col-lg-6">
          <div class="glass-card h-100">
            <div class="card-header border-0 py-2 px-3 d-flex justify-content-between align-items-center">
              <span class="fw-semibold">Elevation Dial</span>
              <span class="badge bg-dark-subtle text-light-emphasis small">0–90°</span>
            </div>
            <div class="card-body">
              <canvas id="elCanvas" width="280" height="260" class="rounded"></canvas>
              <div class="mt-3 dial-texts">
                <p id="elText" class="status-text mb-1">Antenna elevation: --°</p>
                <p id="elMoonText" class="moon-text mb-0">Moon angle: --°</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Camera -->
        <div class="col-xl-4 col-lg-12">
          <div class="glass-card h-100">
            <div class="card-header border-0 py-2 px-3 d-flex justify-content-between align-items-center">
              <span class="fw-semibold">Antenna Camera</span>
              <div class="btn-group btn-group-sm">
                <button id="camFsBtn" type="button" class="btn btn-outline-info">⛶ Fullscreen</button>
              </div>
            </div>

            <div class="card-body">
              <div id="camFsContainer" class="cam-fs-container rounded overflow-hidden position-relative">
                <img
                  id="camStream"
                  src="/video.mjpg?ts=0"
                  data-src="/video.mjpg"
                  alt="Camera stream"
                  class="camera-frame w-100"
                >
                <div id="camOverlay" class="cam-overlay" hidden>
                  No video signal
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>

      <!-- Row 2: coax status + RF schematic -->
      <div class="row g-3">

        <!-- Coax read-only -->
        <div class="col-xl-3 col-lg-6">
          <div class="glass-card h-100 card-coax">
            <div class="card-header border-0 py-2 px-3 d-flex justify-content-between align-items-center">
              <span class="fw-semibold">Coax Switches</span>
              <span class="coax-conn d-inline-flex align-items-center gap-1">
                <span class="coax-dot" id="coax-conn-dot"></span>
                <small id="coax-conn-text">Offline</small>
              </span>
            </div>

            <div class="card-body text-start">
              <div id="coax-status" class="small mb-2"></div>

              <div id="coax-view-grid" class="coax-grid coax-grid-readonly">
                <div class="coax-row">
                  <span class="coax-label">S1</span>
                  <div class="coax-pill-group">
                    <span id="coax-view-1-1" class="coax-pill">1</span>
                    <span id="coax-view-1-2" class="coax-pill">2</span>
                  </div>
                </div>

                <div class="coax-row">
                  <span class="coax-label">S2</span>
                  <div class="coax-pill-group">
                    <span id="coax-view-2-1" class="coax-pill">1</span>
                    <span id="coax-view-2-2" class="coax-pill">2</span>
                  </div>
                </div>

                <div class="coax-row">
                  <span class="coax-label">S3</span>
                  <div class="coax-pill-group">
                    <span id="coax-view-3-1" class="coax-pill">1</span>
                    <span id="coax-view-3-2" class="coax-pill">2</span>
                  </div>
                </div>
              </div>

              <small class="text-muted d-block mt-2">
                Read-only: positions follow the Pico coax switch state.
              </small>
            </div>
          </div>
        </div>

        <!-- RF schematic -->
        <div class="col-xl-9 col-lg-6">
          <div class="glass-card h-100 card-rf">
            <div class="card-header border-0 py-2 px-3 d-flex justify-content-between align-items-center">
              <span class="fw-semibold">RF Path Schematic</span>
              <span class="badge bg-secondary-subtle text-secondary-emphasis small">
                TX &amp; RX paths · live
              </span>
            </div>

            <div class="card-body">
              <div class="coax-schematic-wrap">
                <svg
                  id="rf-schematic"
                  viewBox="0 0 820 300"
                  preserveAspectRatio="xMidYMid meet"
                >
                  <!-- TX and RX sources -->
                  <circle cx="70" cy="110" r="8" stroke="#aaa" stroke-width="1.5" fill="#222" />
                  <text x="70" y="95" text-anchor="middle">TX</text>

                  <circle cx="70" cy="160" r="8" stroke="#aaa" stroke-width="1.5" fill="#222" />
                  <text x="70" y="175" text-anchor="middle">RX</text>

                  <!-- TX → PA input -->
                  <path id="w_tx_to_pa" class="wire" d="M78 110 H 100" />

                  <!-- PA block -->
                  <g transform="translate(120,110)">
                    <rect class="amp-body" x="-20" y="-10" width="40" height="20" />
                    <text class="amp-label" x="0" y="4">PA</text>
                  </g>

                  <!-- PA → S1 P1 -->
                  <path id="w_pa_to_s1p1" class="wire" d="M140 110 H 170" />

                  <!-- RX → S1 P2 -->
                  <path id="w_rx_to_s1p2" class="wire" d="M78 160 H 170" />

                  <!-- Switch 1 -->
                  <g id="switch1" class="switch" data-state="p1" transform="translate(220,140)">
                    <circle class="switch-terminal" cx="-50" cy="-20" r="3" />
                    <circle class="switch-terminal" cx="-50" cy="20"  r="3" />
                    <circle class="switch-com"     cx="0"   cy="0"   r="3.5" />

                    <line id="s1_blade" class="switch-handle" x1="0" y1="0" x2="-50" y2="-20" />
                    <text class="switch-label" x="0" y="-40">S1</text>
                  </g>

                  <!-- S1 COM → S2 COM -->
                  <path id="w_s1com_to_s2com" class="wire" d="M224 140 H 415" />

                  <!-- Switch 2 -->
                  <g id="switch2" class="switch" data-state="p1" transform="translate(415,140)">
                    <circle class="switch-terminal" cx="50" cy="-20" r="3" />
                    <circle class="switch-terminal" cx="50" cy="20"  r="3" />
                    <circle class="switch-com"     cx="0"  cy="0"   r="3.5" />

                    <line id="s2_blade" class="switch-handle" x1="0" y1="0" x2="50" y2="-20" />
                    <text class="switch-label" x="0" y="-40">S2</text>
                  </g>

                  <!-- S2 P1 → LNA -->
                  <path id="w_s2p1_to_lna" class="wire" d="M465 110 H 525" />

                  <!-- LNA block -->
                  <g transform="translate(545,110)">
                    <rect class="amp-body" x="-20" y="-10" width="40" height="20" />
                    <text class="amp-label" x="0" y="4">LNA</text>
                  </g>

                  <!-- LNA → S3 P1 -->
                  <path id="w_lna_to_s3p1" class="wire" d="M565 110 H 625" />

                  <!-- S2 P2 → S3 P2 -->
                  <path id="w_s2p2_to_s3p2" class="wire" d="M465 160 H 625" />

                  <!-- Switch 3 -->
                  <g id="switch3" class="switch" data-state="p1" transform="translate(675,140)">
                    <circle class="switch-terminal" cx="-50" cy="-20" r="3" />
                    <circle class="switch-terminal" cx="-50" cy="20"  r="3" />
                    <circle class="switch-com"     cx="0"   cy="0"   r="3.5" />

                    <line id="s3_blade" class="switch-handle" x1="0" y1="0" x2="-50" y2="-20" />
                    <text class="switch-label" x="0" y="-40">S3</text>
                  </g>

                  <!-- S3 → Antenna -->
                  <path id="w_s3com_to_out" class="wire" d="M679 140 H 750" />

                  <!-- Antenna -->
                  <g id="antenna" transform="translate(750,140)">
                    <line x1="0" y1="0" x2="0" y2="-15" stroke="#ccc" stroke-width="2" />
                    <line x1="0" y1="-15" x2="-10" y2="-23" stroke="#ccc" stroke-width="2" />
                    <line x1="0" y1="-15" x2="10"  y2="-23" stroke="#ccc" stroke-width="2" />
                    <text x="0" y="-26" text-anchor="middle">ANT</text>

                    <!-- TX waves -->
                    <g id="ant_tx_group">
                      <path class="ant-wave ant-wave-tx" d="M6 -23 Q 20 -33 34 -28" />
                      <path class="ant-wave ant-wave-tx" d="M9 -28 Q 26 -40 43 -34" />
                      <path class="ant-wave ant-wave-tx" d="M12 -33 Q 32 -47 52 -40" />
                    </g>

                    <!-- RX waves -->
                    <g id="ant_rx_group">
                      <path class="ant-wave ant-wave-rx" d="M12 -33 Q 32 -47 52 -40" />
                      <path class="ant-wave ant-wave-rx" d="M9 -28 Q 26 -40 43 -34" />
                      <path class="ant-wave ant-wave-rx" d="M6 -23 Q 20 -33 34 -28" />
                    </g>
                  </g>
                </svg>
              </div>

              <small class="text-muted d-block mt-2">
                Read-only: path and RF animation follow the Pico coax state.
              </small>
            </div>
          </div>
        </div>

      </div>
    </section>
  </div>

  <!-- Status bar -->
  <div id="status-bar" class="statusbar">
    {{ state.status }}
  </div>

  <script src="/static/app.js"></script>
</body>
</html>
