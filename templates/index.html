<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MD-01 Controller</title>

  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >

  <!-- Custom styles -->
  <link href="/static/style.css" rel="stylesheet">
</head>

<body class="app-body text-center" data-can-edit="{{ '1' if can_edit else '0' }}">

  <div class="app-shell container-fluid py-3">

    <!-- Header -->
    <header class="mb-3">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div class="d-flex align-items-center gap-2">
          <div class="brand-icon">
            <span>üì°</span>
          </div>
          <div class="text-start">
            <h1 class="h4 mb-0 fw-bold">MD-01 Controller</h1>
            <small class="text-muted d-block">Moon tracking &amp; antenna control</small>
          </div>
        </div>

        <div class="d-flex align-items-center gap-2">
          <form method="post" action="/login" class="d-flex align-items-center gap-2">
            {% if can_edit %}
              <span class="badge bg-success-subtle text-success-emphasis">Control enabled</span>
              <button
                type="submit"
                formaction="/logout"
                class="btn btn-outline-danger btn-sm"
              >
                Logout
              </button>
            {% else %}
              <input
                type="password"
                name="password"
                class="form-control form-control-sm"
                placeholder="Control password"
                autocomplete="current-password"
              >
              <button type="submit" class="btn btn-outline-success btn-sm">
                Login
              </button>
            {% endif %}
          </form>
        </div>
      </div>
    </header>

    <!-- Connection & Movement Row -->
    <section class="mb-3">
      <div class="row g-3 align-items-stretch">

        <!-- Connection -->
        <div class="col-lg-4">
          <div class="glass-card h-100 card-connection">
            <div class="card-header border-0 d-flex justify-content-between align-items-center py-2 px-3">
              <span class="fw-semibold">Connection</span>
              <span class="connection-dot" id="connection-dot"></span>
            </div>
            <div class="card-body pt-2">
              <form id="connectForm" class="d-flex gap-2 mb-2">
                <select name="port" class="form-select form-select-sm">
                  {% for p in ports %}
                    <option value="{{ p }}" {% if state.port == p %}selected{% endif %}>{{ p }}</option>
                  {% endfor %}
                </select>
                <button
                  type="submit"
                  class="btn btn-success btn-sm flex-shrink-0"
                  {% if not can_edit %}disabled{% endif %}
                >
                  Connect
                </button>
              </form>
              <div class="d-flex gap-2 justify-content-between">
                <button
                  id="disconnectBtn"
                  type="button"
                  class="btn btn-outline-danger btn-sm flex-fill"
                  {% if not can_edit %}disabled{% endif %}
                >
                  Disconnect
                </button>
                <div class="small text-muted text-start">
                  <div>Port: <span class="fw-semibold" id="connection-port-text">{{ state.port or "‚Äî" }}</span></div>
                  <div>Status: <span class="fw-semibold" id="connection-status-text">Idle</span></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Movement -->
        <div class="col-lg-8">
          <div class="glass-card h-100 card-target">
            <div class="card-header border-0 d-flex justify-content-between align-items-center py-2 px-3">
              <span class="fw-semibold">Target Position</span>
              <span class="badge bg-secondary-subtle text-secondary-emphasis">
                Step 0.1¬∞ ¬∑ Safety below 15¬∞
              </span>
            </div>
            <div class="card-body">
              <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
                <form id="setForm" class="d-flex flex-wrap flex-md-nowrap gap-2 flex-grow-1">
                  <div class="input-group input-group-sm">
                    <span class="input-group-text">Az</span>
                    <input
                      type="number"
                      name="az"
                      min="-360"
                      max="359"
                      step="0.1"
                      value="{{ state.az }}"
                      class="form-control"
                      placeholder="Azimuth"
                      {% if not can_edit %}disabled{% endif %}
                    >
                  </div>
                  <div class="input-group input-group-sm">
                    <span class="input-group-text">El</span>
                    <input
                      type="number"
                      name="el"
                      min="0"
                      max="100"
                      step="0.1"
                      value="{{ state.el }}"
                      class="form-control"
                      placeholder="Elevation"
                      {% if not can_edit %}disabled{% endif %}
                    >
                  </div>
                  <button
                    type="submit"
                    class="btn btn-primary btn-sm flex-shrink-0"
                    {% if not can_edit %}disabled{% endif %}
                  >
                    Set
                  </button>
                </form>

                <div class="d-flex align-items-center gap-2 ms-md-2">
                  <div class="btn-group btn-group-sm" role="group">
                    <button
                      id="trackerBtn"
                      type="button"
                      class="btn btn-success"
                      {% if not can_edit %}disabled{% endif %}
                    >
                      Tracker Start
                    </button>
                    <button
                      id="stopBtn"
                      type="button"
                      class="btn btn-warning"
                      {% if not can_edit %}disabled{% endif %}
                    >
                      Stop
                    </button>
                    <button
                      id="parkBtn"
                      type="button"
                      class="btn btn-info"
                      {% if not can_edit %}disabled{% endif %}
                    >
                      Park
                    </button>
                  </div>
                </div>
              </div>

              <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                <div class="form-check form-switch small">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="forceElChk"
                    {% if not can_edit %}disabled{% endif %}
                  >
                  <label class="form-check-label" for="forceElChk">
                    Force tracking below 15¬∞
                  </label>
                </div>
                <div class="small text-muted ms-auto">
                  <span class="legend-dot legend-dot-antenna"></span> Antenna
                  <span class="legend-dot legend-dot-moon ms-3"></span> Moon
                  <span class="legend-dot legend-dot-park ms-3"></span> Park
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </section>

    <!-- Main cards row + measurement -->
    <section class="mb-4">
      <div class="row g-3">

        <!-- Azimuth -->
        <div class="col-xl-3 col-lg-6">
          <div class="glass-card h-100">
            <div class="card-header border-0 py-2 px-3 d-flex justify-content-between align-items-center">
              <span class="fw-semibold">Azimuth Dial</span>
              <span class="badge bg-dark-subtle text-light-emphasis small">360¬∞</span>
            </div>
            <div class="card-body">
              <canvas id="azCanvas" width="280" height="260" class="rounded"></canvas>
              <div class="mt-3 dial-texts">
                <p id="azText" class="status-text mb-1">Antenna absolute azimuth: --¬∞</p>
                <p id="azNormText" class="status-text mb-1">Antenna normed azimuth: --¬∞</p>
                <p id="azMoonText" class="moon-text mb-0">Moon angle: --¬∞</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Elevation -->
        <div class="col-xl-3 col-lg-6">
          <div class="glass-card h-100">
            <div class="card-header border-0 py-2 px-3 d-flex justify-content-between align-items-center">
              <span class="fw-semibold">Elevation Dial</span>
              <span class="badge bg-dark-subtle text-light-emphasis small">0‚Äì90¬∞</span>
            </div>
            <div class="card-body">
              <canvas id="elCanvas" width="280" height="260" class="rounded"></canvas>
              <div class="mt-3 dial-texts">
                <p id="elText" class="status-text mb-1">Antenna elevation: --¬∞</p>
                <p id="elMoonText" class="moon-text mb-0">Moon angle: --¬∞</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Camera -->
        <div class="col-xl-3 col-lg-6">
          <div class="glass-card h-100">
            <div class="card-header border-0 d-flex justify-content-between align-items-center py-2 px-3">
              <span class="fw-semibold">Antenna Camera</span>
              <div class="btn-group btn-group-sm">
                <button id="camFsBtn" type="button" class="btn btn-outline-info">
                  ‚õ∂ Fullscreen
                </button>
              </div>
            </div>

            <div class="card-body">
              <div id="camFsContainer" class="cam-fs-container rounded overflow-hidden position-relative">
                <!-- IMPORTANT: src="/video.mjpg" directly -->
                <img
                  id="camStream"
                  src=""
                  data-src="/video.mjpg"
                  alt="Camera stream"
                  class="camera-frame w-100"
                >

                <!-- Overlay controlled by JS -->
                <div id="camOverlay" class="cam-overlay" hidden>
                  <div class="cam-overlay-inner">
                    <span class="display-6 d-block mb-2">‚õî</span>
                    <span class="fw-semibold d-block">No video signal</span>
                    <small class="d-block text-muted">Trying to re-connect‚Ä¶</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Manual control + Coax -->
        <div class="col-xl-3 col-lg-6">
          <div class="glass-card h-100">
            <div class="card-header border-0 py-2 px-3 d-flex justify-content-between align-items-center">
              <div class="d-flex align-items-center gap-2">
                <span class="fw-semibold">Manual Control</span>
                <span class="badge bg-secondary small">INOP</span>
              </div>
            </div>

            <div class="card-body">

              <!-- D-pad -->
              <div class="dpad-wrap">
                <button
                  id="upBtn"
                  type="button"
                  class="btn btn-outline-primary arrow"
                  aria-label="Jog up"
                  {% if not can_edit %}disabled{% endif %}
                >
                  ‚¨ÜÔ∏è
                </button>
                <button
                  id="leftBtn"
                  type="button"
                  class="btn btn-outline-primary arrow"
                  aria-label="Jog left"
                  {% if not can_edit %}disabled{% endif %}
                >
                  ‚¨ÖÔ∏è
                </button>
                <button
                  id="rightBtn"
                  type="button"
                  class="btn btn-outline-primary arrow"
                  aria-label="Jog right"
                  {% if not can_edit %}disabled{% endif %}
                >
                  ‚û°Ô∏è
                </button>
                <button
                  id="downBtn"
                  type="button"
                  class="btn btn-outline-primary arrow"
                  aria-label="Jog down"
                  {% if not can_edit %}disabled{% endif %}
                >
                  ‚¨áÔ∏è
                </button>
              </div>

              <hr class="my-2">

              <!-- Coax switches -->
              <h6 class="mb-1 d-flex justify-content-between align-items-center">
                <span>Coax Switches</span>
                <span class="coax-conn d-inline-flex align-items-center gap-1">
                  <span class="coax-dot" id="coax-conn-dot"></span>
                  <small id="coax-conn-text">Offline</small>
                </span>
              </h6>

              <div id="coax-status" class="small mb-2 text-start"></div>

              <!-- Pico connection controls -->
              <form id="coaxConnectForm" class="d-flex gap-2 mb-2">
                <select
                  name="port"
                  class="form-select form-select-sm"
                  {% if not can_edit %}disabled{% endif %}
                >
                  {% for p in ports %}
                    <option value="{{ p }}" {% if state.switch_port == p %}selected{% endif %}>
                      {{ p }}
                    </option>
                  {% endfor %}
                </select>
                <button
                  id="coaxConnectBtn"
                  type="submit"
                  class="btn btn-success btn-sm"
                  {% if not can_edit %}disabled{% endif %}
                >
                  Connect
                </button>
                <button
                  id="coaxDisconnectBtn"
                  type="button"
                  class="btn btn-outline-danger btn-sm"
                  {% if not can_edit %}disabled{% endif %}
                >
                  Disconnect
                </button>
              </form>

              <div class="small text-muted mb-2 text-start">
                Port: <span class="fw-semibold" id="coax-port-text">{{ state.switch_port or "‚Äî" }}</span>
              </div>


              <div class="coax-grid">
                <div class="coax-row">
                  <span class="coax-label">S1</span>
                  <div class="btn-group btn-group-sm">
                    <button
                      id="coax-1-1"
                      class="btn btn-outline-light coax-btn"
                      onclick="setCoax(1,'1')"
                      {% if not can_edit %}disabled{% endif %}
                    >
                      1
                    </button>
                    <button
                      id="coax-1-2"
                      class="btn btn-outline-light coax-btn"
                      onclick="setCoax(1,'2')"
                      {% if not can_edit %}disabled{% endif %}
                    >
                      2
                    </button>
                  </div>
                </div>

                <div class="coax-row">
                  <span class="coax-label">S2</span>
                  <div class="btn-group btn-group-sm">
                    <button
                      id="coax-2-1"
                      class="btn btn-outline-light coax-btn"
                      onclick="setCoax(2,'1')"
                      {% if not can_edit %}disabled{% endif %}
                    >
                      1
                    </button>
                    <button
                      id="coax-2-2"
                      class="btn btn-outline-light coax-btn"
                      onclick="setCoax(2,'2')"
                      {% if not can_edit %}disabled{% endif %}
                    >
                      2
                    </button>
                  </div>
                </div>

                <div class="coax-row">
                  <span class="coax-label">S3</span>
                  <div class="btn-group btn-group-sm">
                    <button
                      id="coax-3-1"
                      class="btn btn-outline-light coax-btn"
                      onclick="setCoax(3,'1')"
                      {% if not can_edit %}disabled{% endif %}
                    >
                      1
                    </button>
                    <button
                      id="coax-3-2"
                      class="btn btn-outline-light coax-btn"
                      onclick="setCoax(3,'2')"
                      {% if not can_edit %}disabled{% endif %}
                    >
                      2
                    </button>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>

      </div>

      <!-- NEW ROW: Moon distance measurement card -->
      <div class="row g-3 mt-2">
        <div class="col-xl-6 col-lg-8">
          <div class="glass-card h-100">
            <div class="card-header border-0 py-2 px-3 d-flex justify-content-between align-items-center">
              <span class="fw-semibold">Moon Distance Measurement</span>
              <span class="badge bg-secondary-subtle text-secondary-emphasis small">
                Requires tracking &amp; lock
              </span>
            </div>
            <div class="card-body d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between gap-3">
              <div class="text-start">
                <p class="mb-1 small text-muted">
                  Starts a transmit/receive sequence to measure the distance to the Moon.
                </p>
                <p class="mb-0 small text-muted">
                  Enabled only when the rotor is connected, tracking, and locked on the Moon.
                </p>
              </div>
              <div class="text-end">
                <button
                  id="measBtn"
                  type="button"
                  class="btn btn-outline-light btn-sm"
                  {% if not can_edit %}disabled{% endif %}
                >
                  Start measurement
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

    </section>

  </div>

  <!-- Status bar (sticky bottom) -->
  <div id="status-bar" class="statusbar">
    {{ state.status }}
  </div>

  <!-- JS bundle -->
  <script src="/static/app.js"></script>
</body>
</html>
